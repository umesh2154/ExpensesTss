<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Account Settings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='rstyle.css') }}">
  <style>
    .settings-wrap { max-width: 1000px; margin: 24px auto; display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
    .card { background: #fff; border-radius: 8px; padding: 18px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .form-row { display:flex; gap:10px; }
    .form-group { margin-bottom:12px; }
    input[readonly] { background:#f5f5f5; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <div class="settings-wrap">
    <div class="card">
      <h3>Personal Information <small style="float:right"><button id="edit-details" type="button" style="background:transparent;border:0;color:#06c;cursor:pointer;padding:0">Edit Details</button></small></h3>
      <form id="account-form">
        <div class="form-row">
          <div class="form-group">
            <label>First Name</label>
            <input name="first_name" value="{{ user.first_name if user.first_name is defined else user.get('first_name','') }}" readonly />
          </div>
          <div class="form-group">
            <label>Middle Name</label>
            <input name="middle_name" value="{{ user.middle_name if user.middle_name is defined else user.get('middle_name','') }}" readonly />
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input name="last_name" value="{{ user.last_name if user.last_name is defined else user.get('last_name','') }}" readonly />
          </div>
        </div>

        <div class="form-group">
          <label>Email Address</label>
          <input name="email" value="{{ user.email if user.email is defined else user.get('email','') }}" readonly />
          <div style="font-size:12px;color:#777">Email cannot be changed.</div>
        </div>

        <h4>Banking Details</h4>
        <div class="form-group">
          <label>Bank Name</label>
          <input name="bank_name" value="{{ user.bank_name if user.bank_name is defined else user.get('bank_name','') }}" readonly />
        </div>
        <div class="form-group">
          <label>Account No</label>
          <input name="account_no" value="{{ user.account_no if user.account_no is defined else user.get('account_no','') }}" readonly />
        </div>

        <button id="save-account" type="submit" disabled>Save Details</button>
        <p id="account-msg" class="success" style="display:none"></p>
      </form>

      <hr style="margin:18px 0">
      <h4>System Activity Log</h4>
      <div style="min-height:120px; background:#fafafa; padding:12px; border-radius:6px; color:#666">No recent activity to show.</div>
    </div>

    <div class="card">
      <h3>Security</h3>
      <form id="password-form">
        <div class="form-group">
          <label>Current Password</label>
          <input type="password" name="current_password" required />
        </div>
        <div class="form-group">
          <label>New Password</label>
          <input type="password" name="new_password" required />
        </div>
        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" name="confirm_password" required />
        </div>
        <button type="submit">Update Password</button>
        <p id="pwd-msg" class="error" style="display:none"></p>
      </form>
    </div>
  </div>

  <script>
    // Edit Details toggle: enable fields for editing
    (function(){
      const editBtn = document.getElementById('edit-details');
      const form = document.getElementById('account-form');
      const saveBtn = document.getElementById('save-account');
      const inputs = Array.from(form.querySelectorAll('input')).filter(i=>i.name !== 'email');
      let editing = false;
      editBtn.addEventListener('click', function(){
        editing = !editing;
        inputs.forEach(i => { if(editing) i.removeAttribute('readonly'); else i.setAttribute('readonly','readonly'); });
        saveBtn.disabled = !editing;
        editBtn.textContent = editing ? 'Cancel Edit' : 'Edit Details';
        if(editing) inputs[0]?.focus();
      });
    })();
    document.getElementById('account-form').addEventListener('submit', function(e){
      e.preventDefault();
      const fd = new FormData(this);
      fetch('/account/update-profile', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(j => {
          const m = document.getElementById('account-msg');
          if (j.ok) { m.textContent = 'Saved'; m.style.display = 'block'; setTimeout(()=>m.style.display='none',3000); }
          else { m.textContent = j.error || 'Error'; m.style.display='block'; m.className='error'; }
        }).catch(err=>{ console.error(err); });
    });

    document.getElementById('password-form').addEventListener('submit', function(e){
      e.preventDefault();
      const fd = new FormData(this);
      fetch('/account/update-password', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(j => {
          const pm = document.getElementById('pwd-msg');
          if (j.ok) { pm.textContent = 'Password updated'; pm.style.display='block'; pm.className='success'; setTimeout(()=>pm.style.display='none',3000); document.getElementById('password-form').reset(); }
          else { pm.textContent = j.error || 'Error'; pm.style.display='block'; pm.className='error'; }
        }).catch(err=>{ console.error(err); });
    });
  </script>
</body>
</html>
